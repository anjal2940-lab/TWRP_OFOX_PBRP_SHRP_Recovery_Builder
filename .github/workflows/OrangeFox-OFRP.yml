name: GSI Slimmer and Ultra Compressor

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'SourceForge Direct Download Link'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          
      - name: Download GSI
        run: wget -L -O input.img "${{ github.event.inputs.file_url }}"

      - name: Slim Down System Image
        run: |
          # Create a mount point
          mkdir -p mnt
          # GSIs are usually raw images; we mount them to delete files
          # Note: If this fails, the image might be 'sparse'. 
          # We convert to raw first to be safe.
          sudo apt-get install android-sdk-libsparse-utils -y
          simg2img input.img raw_input.img || mv input.img raw_input.img
          
          # Mount the image (Requires offset calculation or standard mount)
          # We use a tool called 'e2fsck' and 'resize2fs' later to shrink the filesystem
          sudo mount -o loop raw_input.img mnt
          
          # DELETE NON-ESSENTIALS (Customize these paths as needed)
          sudo rm -rf mnt/system/media/video/* || true
          sudo rm -rf mnt/system/product/wallpaper/* || true
          sudo rm -rf mnt/system/product/app/YouTube/* || true
          sudo rm -rf mnt/system/product/app/Chrome/* || true
          
          echo "Cleanup finished. Unmounting..."
          sudo umount mnt

      - name: Ultra Compress (256MB Dictionary)
        run: |
          # Using the strongest 7z settings possible on a 7GB RAM runner
          # -mx=9: Ultra
          # -md=256m: Massive dictionary to find redundancies across the whole image
          7z a -mx=9 -m0=lzma2 -md=256m -mfb=273 -ms=on gsi_final.7z raw_input.img
          echo "Final size: $(du -h gsi_final.7z)"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: slim-gsi-500mb-target
          path: gsi_final.7z

