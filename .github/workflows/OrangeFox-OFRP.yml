name: GSI Slimmer to 500MB

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'SourceForge Direct Download Link'
        required: true
        type: string

jobs:
  slim-and-compress:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Runner
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y android-sdk-libsparse-utils binwalk e2fsprogs

      - name: Download and Prepare Image
        run: |
          wget -L -O input.img "${{ github.event.inputs.file_url }}"
          # Convert Sparse to Raw
          simg2img input.img raw_system.img || mv input.img raw_system.img

      - name: Mount and Slimming
        run: |
          mkdir -p mnt
          # Many GSIs have an offset. We try to mount directly first; if it fails, we use loop.
          sudo mount -o loop,rw raw_system.img mnt || sudo mount -o loop,offset=1048576,rw raw_system.img mnt
          
          # DELETE THE BIGGEST OFFENDERS
          sudo rm -rf mnt/system/product/app/YouTube || true
          sudo rm -rf mnt/system/product/app/Chrome || true
          sudo rm -rf mnt/system/product/app/Maps || true
          sudo rm -rf mnt/system/media/video/* || true
          
          # OPTIONAL: Remove extra fonts/sounds if still too big
          # sudo rm -rf mnt/system/media/audio/notifications/* || true
          
          sudo umount mnt

      - name: Shrink Filesystem
        run: |
          # This removes the "empty air" we just created by deleting files
          e2fsck -f -y raw_system.img
          resize2fs -M raw_system.img

      - name: Ultra Compression (256MB Dictionary)
        run: |
          # -mx=9: Ultra
          # -md=256m: Max dictionary for best results
          7z a -mx=9 -m0=lzma2 -md=256m -mfb=273 -ms=on gsi_500mb.7z raw_system.img
          echo "Final size: $(du -h gsi_500mb.7z)"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ultra-slim-gsi
          path: gsi_500mb.7z
